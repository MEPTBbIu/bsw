<?xml version="1.0" encoding="UTF-8"?>
<DataCompositionSchema xmlns="http://v8.1c.ru/8.1/data-composition-system/schema" xmlns:dcscom="http://v8.1c.ru/8.1/data-composition-system/common" xmlns:dcscor="http://v8.1c.ru/8.1/data-composition-system/core" xmlns:dcsset="http://v8.1c.ru/8.1/data-composition-system/settings" xmlns:v8="http://v8.1c.ru/8.1/data/core" xmlns:v8ui="http://v8.1c.ru/8.1/data/ui" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<dataSource>
		<name>ИсточникДанных1</name>
		<dataSourceType>Local</dataSourceType>
	</dataSource>
	<dataSet xsi:type="DataSetQuery">
		<name>НаборДанныхЧек</name>
		<field xsi:type="DataSetFieldField">
			<dataPath>Ссылка</dataPath>
			<field>Ссылка</field>
			<appearance/>
			<inputParameters/>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ИмяТаблицы</dataPath>
			<field>ИмяТаблицы</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Имя таблицы</v8:content>
				</v8:item>
			</title>
			<appearance/>
			<inputParameters/>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Сумма</dataPath>
			<field>Сумма</field>
			<appearance/>
			<inputParameters/>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>СтавкаНДС</dataPath>
			<field>СтавкаНДС</field>
			<appearance/>
			<inputParameters/>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Количество</dataPath>
			<field>Количество</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Количество</v8:content>
				</v8:item>
			</title>
			<appearance/>
			<inputParameters/>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Цена</dataPath>
			<field>Цена</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Цена</v8:content>
				</v8:item>
			</title>
			<appearance/>
			<inputParameters/>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Наименование</dataPath>
			<field>Наименование</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Наименование</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ДисконтнаяКарта</dataPath>
			<field>ДисконтнаяКарта</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>КоличествоБонусныхБаллов</dataPath>
			<field>КоличествоБонусныхБаллов</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>БонуснаяПрограммаЛояльности</dataPath>
			<field>БонуснаяПрограммаЛояльности</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Штрихкод</dataPath>
			<field>Штрихкод</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>НомерСтрокиТовара</dataPath>
			<field>НомерСтрокиТовара</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Номер строки товара</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ОрганизацияКод</dataPath>
			<field>ОрганизацияКод</field>
			<useRestriction>
				<condition>true</condition>
			</useRestriction>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Номер</dataPath>
			<field>Номер</field>
			<useRestriction>
				<condition>true</condition>
			</useRestriction>
			<inputParameters>
				<dcscor:item>
					<dcscor:use>false</dcscor:use>
					<dcscor:parameter>Маска</dcscor:parameter>
					<dcscor:value xsi:type="xs:string">[0-9]</dcscor:value>
				</dcscor:item>
			</inputParameters>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>СуммаДокумента</dataPath>
			<field>СуммаДокумента</field>
			<useRestriction>
				<condition>true</condition>
			</useRestriction>
		</field>
		<dataSource>ИсточникДанных1</dataSource>
		<query>ВЫБРАТЬ
	Товары.Номенклатура КАК Номенклатура,
	Товары.Характеристика КАК Характеристика,
	МАКСИМУМ(Штрихкоды.Штрихкод) КАК Штрихкод
ПОМЕСТИТЬ Штрихкоды
ИЗ
	Документ.ЧекККМ.Товары КАК Товары
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
		ПО Товары.Номенклатура = Штрихкоды.Владелец
			И Товары.Характеристика = Штрихкоды.Характеристика
ГДЕ
	Товары.Ссылка = &amp;ДокументСсылка

СГРУППИРОВАТЬ ПО
	Товары.Номенклатура,
	Товары.Характеристика
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	"СоставЧека" КАК ИмяТаблицы,
	Таблица.Ссылка КАК Ссылка,
	Таблица.ДисконтнаяКарта КАК ДисконтнаяКарта,
	NULL КАК НомерСтрокиТовара,
	NULL КАК Наименование,
	NULL КАК Количество,
	NULL КАК Цена,
	NULL КАК Сумма,
	NULL КАК СтавкаНДС,
	NULL КАК Штрихкод,
	Таблица.ДисконтнаяКарта.БонуснаяПрограммаЛояльности КАК БонуснаяПрограммаЛояльности,
	NULL КАК КоличествоБонусныхБаллов,
	ПОДСТРОКА(Таблица.Номер, 6, 6) КАК Номер,
	ПОДСТРОКА(Таблица.Организация.Код, 8, 2) КАК ОрганизацияКод,
	Таблица.СуммаДокумента КАК СуммаДокумента
{ВЫБРАТЬ
	ИмяТаблицы КАК ИмяТаблицы,
	Ссылка КАК Ссылка,
	ДисконтнаяКарта КАК ДисконтнаяКарта,
	НомерСтрокиТовара КАК НомерСтрокиТовара,
	Наименование КАК Наименование,
	Количество КАК Количество,
	Цена КАК Цена,
	Сумма КАК Сумма,
	СтавкаНДС КАК СтавкаНДС,
	Штрихкод КАК Штрихкод,
	БонуснаяПрограммаЛояльности КАК БонуснаяПрограммаЛояльности,
	КоличествоБонусныхБаллов КАК КоличествоБонусныхБаллов}
ИЗ
	Документ.ЧекККМ КАК Таблица
ГДЕ
	Таблица.Ссылка = &amp;ДокументСсылка

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	"Товары",
	Таблица.Ссылка,
	NULL,
	Таблица.НомерСтроки,
	Таблица.Номенклатура.Наименование,
	Таблица.КоличествоУпаковок,
	ВЫБОР
		КОГДА Таблица.КоличествоУпаковок = 0
			ТОГДА Таблица.Сумма
		ИНАЧЕ Таблица.Сумма / Таблица.КоличествоУпаковок
	КОНЕЦ,
	Таблица.Сумма,
	Таблица.СтавкаНДС,
	Штрихкоды.Штрихкод,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL
ИЗ
	Документ.ЧекККМ.Товары КАК Таблица
		ЛЕВОЕ СОЕДИНЕНИЕ Штрихкоды КАК Штрихкоды
		ПО Таблица.Номенклатура = Штрихкоды.Номенклатура
			И Таблица.Характеристика = Штрихкоды.Характеристика
ГДЕ
	Таблица.Ссылка = &amp;ДокументСсылка

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	"БонусныеБаллыКНачислению",
	ЕСТЬNULL(Таблица.Ссылка, Чек.Ссылка),
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	Таблица.БонуснаяПрограммаЛояльности,
	СУММА(ЕСТЬNULL(Таблица.КоличествоБонусныхБаллов, 0)),
	NULL,
	NULL,
	NULL
ИЗ
	Документ.ЧекККМ КАК Чек
		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЧекККМ.БонусныеБаллыКНачислению КАК Таблица
		ПО Чек.Ссылка = Таблица.Ссылка
ГДЕ
	Чек.Ссылка = &amp;ДокументСсылка

СГРУППИРОВАТЬ ПО
	ЕСТЬNULL(Таблица.Ссылка, Чек.Ссылка),
	Таблица.БонуснаяПрограммаЛояльности</query>
	</dataSet>
	<calculatedField>
		<dataPath>ПолеНомер</dataPath>
		<expression>ВЫБОР КОГДА СуммаДокумента &gt;= 3000 И ДисконтнаяКарта = ЗНАЧЕНИЕ(Справочник.ИнформационныеКарты.ПустаяСсылка) ТОГДА ОрганизацияКод + Номер КОНЕЦ</expression>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Поле номер</v8:content>
			</v8:item>
		</title>
		<useRestriction>
			<condition>true</condition>
		</useRestriction>
	</calculatedField>
	<parameter>
		<name>ДокументСсылка</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Документ ссылка</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type xmlns:d4p1="http://v8.1c.ru/8.1/data/enterprise/current-config">d4p1:DocumentRef.ЧекККМ</v8:Type>
		</valueType>
		<value xsi:nil="true"/>
		<useRestriction>false</useRestriction>
		<use>Always</use>
	</parameter>
	<settingsVariant>
		<dcsset:name>Основной</dcsset:name>
		<dcsset:presentation xsi:type="xs:string">Основной</dcsset:presentation>
		<dcsset:settings xmlns:style="http://v8.1c.ru/8.1/data/ui/style" xmlns:sys="http://v8.1c.ru/8.1/data/ui/fonts/system" xmlns:web="http://v8.1c.ru/8.1/data/ui/colors/web" xmlns:win="http://v8.1c.ru/8.1/data/ui/colors/windows">
			<dcsset:selection>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>ИмяТаблицы</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Ссылка</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>ДисконтнаяКарта</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>НомерСтрокиТовара</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Наименование</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Количество</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Цена</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Сумма</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>СтавкаНДС</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Штрихкод</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>БонуснаяПрограммаЛояльности</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>КоличествоБонусныхБаллов</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Номер</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>ОрганизацияКод</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>ПолеНомер</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>СуммаДокумента</dcsset:field>
				</dcsset:item>
			</dcsset:selection>
			<dcsset:dataParameters>
				<dcscor:item xsi:type="dcsset:SettingsParameterValue">
					<dcscor:parameter>ДокументСсылка</dcscor:parameter>
					<dcscor:value xmlns:d6p1="http://v8.1c.ru/8.1/data/enterprise/current-config" xsi:type="d6p1:DocumentRef.ЧекККМ">6a2ccf83-b9b3-11e7-810d-00155d01bb17</dcscor:value>
				</dcscor:item>
			</dcsset:dataParameters>
			<dcsset:item xsi:type="dcsset:StructureItemGroup">
				<dcsset:order>
					<dcsset:item xsi:type="dcsset:OrderItemAuto"/>
				</dcsset:order>
				<dcsset:selection>
					<dcsset:item xsi:type="dcsset:SelectedItemAuto"/>
				</dcsset:selection>
			</dcsset:item>
		</dcsset:settings>
	</settingsVariant>
</DataCompositionSchema>